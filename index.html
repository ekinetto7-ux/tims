<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TIMS Simulator</title>

<style>
body {
  margin: 0;
  background: #000814;
  color: white;
  font-family: sans-serif;
}

.screen {
  padding: 20px;
  height: 100vh;
  position: relative;
  box-sizing: border-box;
}

/* ===== 表示 ===== */
.station-box {
  text-align: center;
  margin-top: 20px;
}

#current-station {
  font-size: 30px;
}

#next-station {
  margin-top: 6px;
  font-size: 18px;
}

#info {
  margin-top: 8px;
  font-size: 18px;
}

.yellow {
  color: #ffd400;
  font-weight: bold;
}

.blink {
  animation: blink 1.8s step-start infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}

/* ===== 編成 ===== */
.formation {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin-top: 20px;
}

.car {
  width: 34px;
  height: 48px;
  border: 2px solid #4aa3ff;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: #001d3d;
}

.car.selected {
  background: #ffd400;
  color: black;
}

/* ===== 下部ボタン ===== */
.bottom-controls {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 14px;
}

button {
  padding: 14px 22px;
  font-size: 16px;
  border-radius: 6px;
  border: 2px solid #4aa3ff;
  background: #001d3d;
  color: white;
  cursor: pointer;
}

button:active {
  background: white;
  color: black;
}

button.disabled {
  opacity: 0.4;
  pointer-events: none;
}

.emergency {
  border-color: #ff4444;
  background: #3a0000;
}
</style>
</head>

<body>

<div class="screen">

  <div class="station-box">
    <div id="current-station"></div>
    <div id="next-station"></div>
    <div id="info"></div>
  </div>

  <!-- 編成 -->
  <div class="formation" id="formation"></div>

  <!-- ボタン -->
  <div class="bottom-controls">
    <button id="next-btn" onclick="nextAction()">次の駅</button>
    <button onclick="toggleAddonDoorCut()">増結ドアカット</button>
    <button class="emergency" onclick="toggleEmergency()">非常</button>
  </div>

</div>

<script>
/* ===== 電子音 ===== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playButtonSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "square";
  osc.frequency.value = 1200;
  gain.gain.value = 0.15;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.08);
}

/* ===== 駅 ===== */
const stations = [
  "君津","木更津","袖ケ浦","長浦","姉ケ崎","五井","八幡宿","浜野",
  "蘇我","千葉","稲毛","津田沼","船橋","市川","新小岩",
  "錦糸町","馬喰町","新日本橋","東京"
];

let index = 0;
let running = false;
let emergency = false;

/* ===== 編成 ===== */
const totalCars = 15;
let doorCutCars = new Set();

/* ===== 編成描画 ===== */
function renderFormation() {
  const f = document.getElementById("formation");
  f.innerHTML = "";

  for (let i = 1; i <= totalCars; i++) {
    const car = document.createElement("div");
    car.className = "car";

    car.textContent = i <= 11 ? i : "増" + (i - 11);

    if (doorCutCars.has(i)) car.classList.add("selected");

    car.onclick = () => {
      if (emergency) return;
      playButtonSound();
      doorCutCars.has(i) ? doorCutCars.delete(i) : doorCutCars.add(i);
      renderFormation();
    };

    f.appendChild(car);
  }
}

/* ===== 表示更新 ===== */
function updateDisplay() {
  const current = document.getElementById("current-station");
  const next = document.getElementById("next-station");
  const info = document.getElementById("info");
  const nextBtn = document.getElementById("next-btn");

  info.innerHTML = "";

  if (emergency) {
    info.innerHTML = "<span class='yellow'>非常扱い中</span>";
    nextBtn.classList.add("disabled");
  } else {
    nextBtn.classList.remove("disabled");
  }

  if (index === stations.length - 1) {
    current.innerHTML =
      "<span class='yellow blink'>東京</span> <span class='yellow blink'>終点</span>";
    next.textContent = "―";
    nextBtn.classList.add("disabled");
    return;
  }

  current.textContent =
    index === 0 && !running ? "君津（始発）" : stations[index];
  next.textContent = "次は " + stations[index + 1];

  if (stations[index] === "千葉") {
    info.innerHTML += "<span class='yellow'>総武快速線直通</span>　";
  }

  info.innerHTML += running ? "ドア閉" : "ドア開";
}

/* ===== 操作 ===== */
function nextAction() {
  playButtonSound();
  if (emergency) return;

  if (!running) {
    running = true;
  } else {
    running = false;
    index++;
  }
  updateDisplay();
}

function toggleEmergency() {
  playButtonSound();
  emergency = !emergency;
  updateDisplay();
}

function toggleAddonDoorCut() {
  playButtonSound();
  if (emergency) return;

  let allOn = true;
  for (let i = 12; i <= 15; i++) {
    if (!doorCutCars.has(i)) allOn = false;
  }

  for (let i = 12; i <= 15; i++) {
    allOn ? doorCutCars.delete(i) : doorCutCars.add(i);
  }
  renderFormation();
}

/* 初期化 */
renderFormation();
updateDisplay();
</script>

</body>
</html>
  
