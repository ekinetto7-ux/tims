<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>運転支援システム</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#111;
  color:#fff;
}
header{
  background:#222;
  padding:10px;
  text-align:center;
}

button{
  font-size:22px;
  padding:18px 30px;
  margin:10px;
  cursor:pointer;
}
.big{font-size:26px;padding:22px 36px;}
.yellow{background:#ffd800;color:#000;}
.red{background:#c00;color:#fff;}

.center{text-align:center;}
.hidden{display:none;}

#status{
  font-size:24px;
  margin:15px;
}
.normal{color:#0f0;}
.emergency{color:red;font-weight:bold;}

#homeBtn{
  position:fixed;
  top:10px;
  right:10px;
  z-index:50;
  font-size:18px;
  padding:12px 18px;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.overlay.active{display:flex;}

.box{
  background:#222;
  border:2px solid red;
  padding:30px;
  max-width:520px;
}
.box p{
  color:red;
  font-size:20px;
}
</style>
</head>

<body>

<button id="homeBtn" onclick="goHome()">初期画面</button>

<header>
  <h2>運転支援システム</h2>
</header>

<div id="status" class="normal center">平常運転しています</div>

<div id="homeScreen" class="center">
  <button class="big red" onclick="emergencyButton()">非常</button>
</div>

<!-- 非常理由選択 -->
<div id="reasonOverlay" class="overlay">
  <div class="box center">
    <h3>非常理由を選択</h3>
    <button onclick="startEmergency('人身事故')">人身事故</button><br>
    <button onclick="startEmergency('地震')">地震</button><br>
    <button onclick="startEmergency('線路内侵入')">線路内侵入</button><br>
    <button onclick="startEmergency('火災')">火災</button>
  </div>
</div>

<!-- 非常内容表示 -->
<div id="messageOverlay" class="overlay">
  <div class="box center">
    <p id="emergencyText"></p>
  </div>
</div>

<!-- 非常解除確認 -->
<div id="releaseOverlay" class="overlay">
  <div class="box center">
    <h3>非常を解除しますか？</h3>
    <button class="big yellow" onclick="releaseEmergency()">非常解除</button>
  </div>
</div>

<div class="center">
  <h3>非常履歴</h3>
  <ul id="log"></ul>
</div>

<script>
let emergency=false;
let logs=[];
let currentIndex=null;

let currentSection="君津 → 木更津";
let trainState="停車中";

function now(){
  return new Date().toLocaleTimeString();
}

function goHome(){
  if(emergency) return;
  document.getElementById("homeScreen").classList.remove("hidden");
}

function emergencyButton(){
  if(!emergency){
    document.getElementById("reasonOverlay").classList.add("active");
  }else{
    document.getElementById("releaseOverlay").classList.add("active");
  }
}

function emergencyMessage(reason){
  const map={
    "人身事故":"直ちに、消防、警察、車掌に連絡すること",
    "地震":"直ちに高台に避難すること。車掌と連携し指令に報告",
    "線路内侵入":"直ちに他の列車に連絡。警察にも連絡",
    "火災":"占められる窓は全て閉める。乗客を安全な場所へ避難。トンネル内停車を避けること"
  };
  return map[reason];
}

function startEmergency(reason){
  emergency=true;
  document.getElementById("homeBtn").classList.add("hidden");
  document.getElementById("reasonOverlay").classList.remove("active");

  document.getElementById("status").textContent="非常扱い";
  document.getElementById("status").className="emergency";

  document.getElementById("emergencyText").textContent=
    reason + "： " + emergencyMessage(reason);
  document.getElementById("messageOverlay").classList.add("active");

  logs.unshift({
    reason,
    section:currentSection,
    state:trainState,
    start:now(),
    end:null
  });
  currentIndex=0;
  renderLog();
}

function releaseEmergency(){
  emergency=false;

  document.getElementById("releaseOverlay").classList.remove("active");
  document.getElementById("messageOverlay").classList.remove("active");

  document.getElementById("status").textContent="平常運転しています";
  document.getElementById("status").className="normal";

  document.getElementById("homeBtn").classList.remove("hidden");

  if(currentIndex!==null){
    logs[currentIndex].end=now();
    currentIndex=null;
  }
  renderLog();
}

function renderLog(){
  const ul=document.getElementById("log");
  ul.innerHTML="";
  logs.forEach(l=>{
    const li=document.createElement("li");
    li.innerHTML=
      `理由：${l.reason}<br>
       区間：${l.section}<br>
       状態：${l.state}<br>
       発生：${l.start}<br>
       解除：${l.end ?? "未解除"}`;
    ul.appendChild(li);
  });
}
</script>

</body>
</html>
