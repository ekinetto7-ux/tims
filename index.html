<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>運転支援システム</title>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:sans-serif;
  font-size:18px;
}

#homeBtn{
  position:fixed;
  top:10px;
  right:10px;
  z-index:500;
  padding:10px 16px;
  font-size:16px;
}

.hidden{display:none;}

.screen{
  display:none;
  height:100vh;
  justify-content:center;
  align-items:center;
  flex-direction:column;
}
.screen.active{display:flex;}

#status{
  font-size:26px;
  margin:20px;
}
.normal{color:#0f0;}
.emergency{color:red;font-weight:bold;}

button{cursor:pointer;}

.red{
  background:#c00;
  color:#fff;
  font-size:26px;
  padding:20px 36px;
}

.yellow{
  background:#ffd800;
  color:#000;
  font-size:24px;
  padding:18px 34px;
  margin-top:30px;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:300;
}
.overlay.active{display:flex;}

.box{
  border:2px solid red;
  padding:30px;
  max-width:520px;
  background:#000;
  text-align:center;
}

/* 次駅 一瞬消える */
.cut{
  animation: cutSwap 0.2s steps(1) both;
}
@keyframes cutSwap{
  0%{opacity:0;}
  100%{opacity:1;}
}

/* 通過 一瞬強調 */
.pass-emphasis{
  font-weight:bold;
  font-size:22px;
  color:#4aa3ff;
}

/* 停車中一瞬表示 */
#tempStatus{
  font-size:22px;
  margin-top:10px;
}
</style>
</head>

<body>

<button id="homeBtn" onclick="goHome()">初期選択</button>

<div id="initialScreen" class="screen active">
  <h2>初期選択</h2>
  <button onclick="enterMain()">運転士</button>
  <button onclick="enterMain()">車掌</button>
  <button onclick="enterMain()">ワンマン</button>
</div>

<div id="mainScreen" class="screen">
  <div id="status" class="normal">平常運転しています</div>

  <div id="operationInfo" style="font-size:28px;color:yellow;">木更津</div>
  <div id="tempStatus"></div>

  <button onclick="nextStation()">次駅</button>
  <br><br>
  <button class="red" onclick="openReason()">非常</button>
</div>

<div id="reasonOverlay" class="overlay">
  <div class="box">
    <p style="font-size:22px;">非常理由を選択</p>
    <button class="red" onclick="startEmergency('人身事故')">人身事故</button><br><br>
    <button class="red" onclick="startEmergency('地震')">地震</button><br><br>
    <button class="red" onclick="startEmergency('線路内侵入')">線路内侵入</button><br><br>
    <button class="red" onclick="startEmergency('火災')">火災</button>
  </div>
</div>

<div id="messageOverlay" class="overlay">
  <div class="box">
    <p id="emergencyText" style="color:red;font-size:22px;"></p>
    <button class="yellow" onclick="releaseEmergency()">非常解除</button>
  </div>
</div>

<script>
let emergency=false;
let index=0;
let passPhase=false;

const stations=[
  "木更津",
  "巌根（通過）",
  "袖ヶ浦"
];

function hideAll(){
  document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('active'));
}

function enterMain(){
  initialScreen.classList.remove("active");
  mainScreen.classList.add("active");
}

function goHome(){
  if(emergency) return;
  mainScreen.classList.remove("active");
  initialScreen.classList.add("active");
}

function openReason(){
  if(emergency) return;
  hideAll();
  reasonOverlay.classList.add("active");
}

function startEmergency(reason){
  emergency=true;
  hideAll();
  homeBtn.classList.add("hidden");
  status.textContent="非常モードです。安全を確認してください";
  status.className="emergency";
  emergencyText.textContent=reason+"：\n"+messageFor(reason);
  messageOverlay.classList.add("active");
}

function releaseEmergency(){
  emergency=false;
  hideAll();
  homeBtn.classList.remove("hidden");
  status.textContent="平常運転しています";
  status.className="normal";
}

function messageFor(r){
  return{
    "人身事故":"直ちに、消防・警察・車掌に連絡すること",
    "地震":"高台に避難し、車掌と連携し指令に報告",
    "線路内侵入":"他列車および警察に連絡",
    "火災":"窓を閉め、乗客を避難、トンネル内停車を避ける"
  }[r];
}

/* ===== 次駅ロジック ===== */
function updateNextStation(text){
  operationInfo.classList.remove("cut");
  void operationInfo.offsetWidth;
  operationInfo.textContent=text;
  operationInfo.classList.add("cut");
}

function showPassOnce(){
  operationInfo.classList.add("pass-emphasis");
  setTimeout(()=>operationInfo.classList.remove("pass-emphasis"),300);
}

function showStopMoment(name){
  tempStatus.textContent="停車中";
  setTimeout(()=>{ tempStatus.textContent=name; },800);
}

function nextStation(){
  if(stations[index]==="巌根（通過）" && !passPhase){
    updateNextStation("巌根（通過）");
    showPassOnce();
    passPhase=true;
    return;
  }
  passPhase=false;
  index=(index+1)%stations.length;
  updateNextStation(stations[index]);
  showStopMoment(stations[index]);
}
</script>

</body>
</html>
