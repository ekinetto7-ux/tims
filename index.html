<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>列車運行シミュレーター</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

#lineName{
  position:absolute;
  top:10px;
  left:10px;
  font-size:18px;
  font-weight:bold;
}

#main{
  padding-top:50px;
  text-align:center;
}

#stationWrap{
  font-size:28px;
  margin:20px 0;
}

#terminalTag{
  margin-left:6px;
  color:#ffd700;
  display:none;
}

#info{
  margin:20px;
  font-size:16px;
}

#stopTimer{
  margin-top:10px;
}

#bottomControls{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:12px;
}

button{
  font-size:18px;
  padding:16px 20px;
  border:none;
  border-radius:12px;
}

#nextBtn{
  background:#1e88e5;
  color:#fff;
  min-width:140px;
}

#emergencyBtn{
  background:#d32f2f;
  color:#fff;
  min-width:100px;
}

button:disabled{
  opacity:0.4;
}

@keyframes blinkSlow{
  0%,50%,100%{opacity:1;}
  25%,75%{opacity:0;}
}
.blink{
  animation:blinkSlow 1.2s infinite;
}
</style>
</head>

<body>

<div id="lineName"></div>

<div id="main">
  <div id="stationWrap">
    <span id="stationName"></span>
    <span id="terminalTag">終点</span>
  </div>

  <div id="info">
    <div id="nextStation"></div>
    <div id="stopTimer"></div>
  </div>
</div>

<div id="bottomControls">
  <button id="nextBtn">次の駅</button>
  <button id="emergencyBtn">非常</button>
</div>

<audio id="lineChangeSound" src="chime.mp3"></audio>

<script>
/* ===== データ ===== */
const stations = [
  "君津","木更津","袖ケ浦","長浦","姉ケ崎","五井","八幡宿","浜野",
  "蘇我","千葉","稲毛","津田沼","船橋","市川","新小岩",
  "錦糸町","馬喰町","新日本橋","東京"
];

const uchiBoStations = [
  "君津","木更津","袖ケ浦","長浦","姉ケ崎",
  "五井","八幡宿","浜野","蘇我","千葉"
];

const sobuRapidStations = [
  "稲毛","津田沼","船橋","市川","新小岩",
  "錦糸町","馬喰町","新日本橋","東京"
];

/* ===== 状態 ===== */
let idx = 0;
let running = false;
let emergency = false;
let stopSeconds = 0;
let stopInterval = null;

/* ===== 要素 ===== */
const stationName = document.getElementById("stationName");
const terminalTag = document.getElementById("terminalTag");
const nextStationDiv = document.getElementById("nextStation");
const stopTimer = document.getElementById("stopTimer");
const nextBtn = document.getElementById("nextBtn");
const emergencyBtn = document.getElementById("emergencyBtn");

/* ===== 共通 ===== */
function isTerminal(){
  return stations[idx] === "東京";
}

function formatTime(sec){
  const m = Math.floor(sec/60).toString().padStart(2,"0");
  const s = (sec%60).toString().padStart(2,"0");
  return `${m}:${s}`;
}

function getTargetStopTime(){
  if(stations[idx]==="千葉") return 180;
  if(stations[idx]==="東京") return Infinity;
  return 45;
}

/* ===== 路線表示 ===== */
function updateLineName(){
  const lineDiv = document.getElementById("lineName");
  const st = stations[idx];

  if(uchiBoStations.includes(st)){
    lineDiv.textContent="内房線";
    lineDiv.style.color="#ffd700";
  }else if(sobuRapidStations.includes(st)){
    lineDiv.textContent="総武快速線";
    lineDiv.style.color="#4fc3f7";
  }else{
    lineDiv.textContent="";
  }
}

/* ===== 終点点滅 ===== */
function updateTerminalBlink(){
  const lineDiv=document.getElementById("lineName");

  if(isTerminal()){
    terminalTag.style.display="inline";
    stationName.classList.add("blink");
    terminalTag.classList.add("blink");
    lineDiv.classList.add("blink");
  }else{
    terminalTag.style.display="none";
    stationName.classList.remove("blink");
    terminalTag.classList.remove("blink");
    lineDiv.classList.remove("blink");
  }
}

/* ===== 音 ===== */
function playLineChangeSound(){
  const s=document.getElementById("lineChangeSound");
  if(!s) return;
  s.currentTime=0; s.play();
  setTimeout(()=>{s.currentTime=0; s.play();},500);
}

/* ===== タイマー ===== */
function startStopTimer(){
  clearInterval(stopInterval);
  stopInterval=setInterval(()=>{
    if(!running && !emergency){
      stopSeconds++;
      const target=getTargetStopTime();
      if(isTerminal()){
        stopTimer.textContent="終点 到着";
      }else if(stopSeconds>=target){
        stopTimer.textContent="停車中（目安超過）";
      }else{
        stopTimer.textContent=
          `停車中 ${formatTime(stopSeconds)} / ${formatTime(target)}`;
      }
    }
  },1000);
}

/* ===== 更新 ===== */
function update(){
  stationName.textContent=stations[idx];
  nextStationDiv.textContent=
    idx<stations.length-1 ? `次は ${stations[idx+1]}` : "";

  stopSeconds=0;
  startStopTimer();
  updateLineName();
  updateTerminalBlink();
  updateButtonState();
}

/* ===== ボタン ===== */
function updateButtonState(){
  const lock=isTerminal();
  nextBtn.disabled=lock;
  emergencyBtn.disabled=lock;
}

nextBtn.onclick=()=>{
  if(isTerminal()||emergency||running) return;
  running=true;

  setTimeout(()=>{
    const prev=stations[idx];
    idx++;
    update();
    if(prev==="千葉") playLineChangeSound();
    running=false;
  },1000);
};

emergencyBtn.onclick=()=>{
  if(isTerminal()) return;
  emergency=!emergency;
  emergencyBtn.textContent=emergency?"非常解除":"非常";
};

/* ===== 初期 ===== */
update();
</script>

</body>
</html>
